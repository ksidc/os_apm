# 웹서버 튜닝 스크립트 통합 가이드

**프로젝트**: iteasy_tuning
**버전**: v2.0
**지원 OS**: CentOS 7, Rocky Linux 8/9, Ubuntu 18.04/20.04/22.04/24.04
**작성일**: 2025-11-05

---

## 목차

1. [개요](#1-개요)
2. [지원 OS 한눈에 보기](#2-지원-os-한눈에-보기)
3. [RHEL vs Debian 계열 비교](#3-rhel-vs-debian-계열-비교)
4. [RHEL 계열 상세 가이드](#4-rhel-계열-상세-가이드)
5. [Debian 계열 상세 가이드](#5-debian-계열-상세-가이드)
6. [스크립트 구조 및 기능](#6-스크립트-구조-및-기능)
7. [튜닝 로직 및 계산 공식](#7-튜닝-로직-및-계산-공식)
8. [실행 가이드](#8-실행-가이드)
9. [트러블슈팅](#9-트러블슈팅)

---

## 1. 개요

### 1.1 프로젝트 목적

본 튜닝 스크립트는 **Apache와 MySQL/MariaDB 서버의 성능을 자동으로 최적화**하는 도구입니다.

**주요 기능**:
- 시스템 리소스(메모리, CPU) 자동 탐지
- 6가지 서비스 프로필에 따른 메모리 자동 배분
- Apache MPM 설정 최적화 (Prefork/Worker/Event)
- MySQL/MariaDB 설정 최적화 (InnoDB/MyISAM/Mixed)
- 안전한 백업 및 복원 지원
- HTML 보고서 자동 생성

### 1.2 지원 범위

**✅ 지원하는 설치 방식**:
- APT 패키지 설치 (Ubuntu)
- YUM 패키지 설치 (CentOS 7)
- DNF 패키지 설치 (Rocky 8/9)

**❌ 지원하지 않는 설치 방식**:
- 소스 컴파일 설치
- 타사 리포지토리 설치

**✅ 지원 서비스**:
- Apache (httpd/apache2)
- MySQL
- MariaDB

**❌ 미지원 서비스**:
- Nginx
- PHP-FPM
- Tomcat

### 1.3 설치 경로

모든 OS에서 **동일한 경로** 사용:
```
/usr/local/src/iteasy_tuning/
```

---

## 2. 지원 OS 한눈에 보기

### 2.1 전체 OS 비교표

| OS | 코드명 | Kernel | Apache | MySQL | MariaDB | 패키지 관리자 | 
|---|--------|--------|--------|-------|---------|--------------|
| **CentOS 7** | - | 3.10.x | 2.4.6 | 5.7 | 10.5 | **YUM** | 
| **Rocky 8** | - | 4.18.x | 2.4.37 | 8.0 | 10.3 | **DNF** |
| **Rocky 9** | - | 5.14.x | 2.4.53 | 8.0 | 10.5 | **DNF** |
| **Ubuntu 18.04** | Bionic | 4.15.x | 2.4.29 | 5.7 | 10.1 | **APT** | 
| **Ubuntu 20.04** | Focal | 5.4.x | 2.4.41 | 8.0 | 10.3 | **APT** |
| **Ubuntu 22.04** | Jammy | 5.15.x | 2.4.52 | 8.0 | 10.6 | **APT** | 
| **Ubuntu 24.04** | Noble | 6.5.x | 2.4.58 | 8.0 | 10.11 | **APT** | 

### 2.2 OS 계열 분류

#### RHEL 계열 (RedHat Enterprise Linux)
```
CentOS 7 (c7)
   ↓
Rocky Linux 8 (r8)
   ↓
Rocky Linux 9 (r9)
```

**공통 특징**:
- Apache 패키지명: `httpd`
- Apache 경로: `/etc/httpd/`
- MySQL 경로: `/etc/my.cnf`, `/etc/my.cnf.d/`
- InnoDB 로그 파일 자동 관리

#### Debian 계열
```
Ubuntu 18.04 (u18)
   ↓
Ubuntu 20.04 (u20)
   ↓
Ubuntu 22.04 (u22)
   ↓
Ubuntu 24.04 (u24)
```

**공통 특징**:
- Apache 패키지명: `apache2`
- Apache 경로: `/etc/apache2/`
- MySQL 경로: `/etc/mysql/`
- 설정 검증 자동 실행 (`apachectl configtest`)
- Reload 지원 (무중단 설정 적용)

---

## 3. RHEL vs Debian 계열 비교

### 3.1 Apache 관련 차이점

| 항목 | RHEL (CentOS/Rocky) | Debian (Ubuntu) |
|------|---------------------|-----------------|
| **패키지명** | `httpd` | `apache2` |
| **바이너리 경로** | `/usr/sbin/httpd` | `/usr/sbin/apache2` |
| **기본 설정 파일** | `/etc/httpd/conf/httpd.conf` | `/etc/apache2/apache2.conf` |
| **MPM 설정 경로** | `/etc/httpd/conf.modules.d/00-mpm.conf` | `/etc/apache2/mods-available/mpm_*.conf` |
| **설정 디렉토리** | `/etc/httpd/` | `/etc/apache2/` |
| **모듈 디렉토리** | `/etc/httpd/conf.modules.d/` | `/etc/apache2/mods-available/` |
| **활성 모듈** | httpd.conf에 직접 로드 | `/etc/apache2/mods-enabled/` (심볼릭 링크) |
| **서비스명** | `httpd` | `apache2` |
| **제어 명령어** | `httpd -V` | `apache2ctl -V`, `a2query -m` |
| **MPM 탐지** | `httpd -V \| grep 'Server MPM'` | `a2query -m \| grep mpm_` |
| **모듈 활성화** | LoadModule 지시어 수정 | `a2enmod mpm_event` |
| **모듈 비활성화** | `#LoadModule`로 주석 처리 | `a2dismod mpm_prefork` |
| **설정 검증** | ❌ 없음 | ✅ `apachectl configtest` |
| **Reload 지원** | ❌ restart만 가능 | ✅ `systemctl reload apache2` |
| **로그 디렉토리** | `/var/log/httpd/` | `/var/log/apache2/` |

### 3.2 MySQL/MariaDB 관련 차이점

| 항목 | RHEL (CentOS/Rocky) | Debian (Ubuntu) |
|------|---------------------|-----------------|
| **MySQL 바이너리** | `/usr/libexec/mysqld` | `/usr/sbin/mysqld` |
| **MariaDB 바이너리** | `/usr/libexec/mariadbd` | `/usr/sbin/mariadbd` |
| **MySQL 기본 설정** | `/etc/my.cnf` | `/etc/mysql/mysql.conf.d/mysqld.cnf` |
| **MariaDB 기본 설정** | `/etc/my.cnf.d/server.cnf` | `/etc/mysql/mariadb.conf.d/50-server.cnf` |
| **튜닝 설정 저장** | `/etc/my.cnf.d/zz-iteasy_tuning.cnf` | `/etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf` |
| **설정 디렉토리** | `/etc/`, `/etc/my.cnf.d/` | `/etc/mysql/` |
| **MySQL 서비스명** | `mysqld` | `mysql` |
| **MariaDB 서비스명** | `mariadb` | `mariadb` |
| **InnoDB 로그 관리** | ✅ 자동 제거 (크기 변경 시) | ❌ 없음 |
| **서비스 유닛 감지** | 고정값 사용 | SERVICE_LOG에서 동적 읽기 |
| **실패 시 복원** | ❌ 없음 | ✅ 자동 복원 로직 |
| **로그 디렉토리** | `/var/log/` | `/var/log/mysql/` |
| **데이터 디렉토리** | `/var/lib/mysql/` | `/var/lib/mysql/` (동일) |

### 3.3 패키지 관리자 차이점

| 항목 | CentOS 7 | Rocky 8/9 | Ubuntu |
|------|----------|-----------|--------|
| **패키지 관리자** | YUM | DNF | APT |
| **설치 명령어** | `yum install httpd` | `dnf install httpd` | `apt install apache2` |
| **검색 명령어** | `yum search` | `dnf search` | `apt search` |
| **패키지 확인** | `rpm -qa \| grep httpd` | `rpm -qa \| grep httpd` | `dpkg -l \| grep apache2` |
| **리포지토리** | `/etc/yum.repos.d/` | `/etc/yum.repos.d/` | `/etc/apt/sources.list` |

### 3.4 스크립트 동작 차이점

| 스크립트 | RHEL | Debian | 차이점 |
|---------|------|--------|--------|
| **find_services.sh** | `httpd -V` 사용 | `apache2ctl -V`, `a2query -m` 사용 | MPM 탐지 방법 다름 |
| **apply_apache.sh** | 복사 후 restart | 복사 → **configtest** → reload/restart | Ubuntu는 검증 추가 |
| **apply_mysql.sh** | InnoDB 로그 제거 로직 | SERVICE_LOG 읽기 + 자동 복원 | Ubuntu는 안전장치 추가 |
| **apply_mariadb.sh** | ✅ 별도 존재 | ❌ 없음 (apply_mysql.sh로 통합) | Ubuntu는 통합 처리 |

### 3.5 기본 MPM 모드 차이

| OS | 기본 MPM | 설명 |
|----|----------|------|
| **CentOS 7** | **Prefork** | 프로세스 기반, 안정성 우선 |
| **Rocky 8/9** | **Event** | 멀티스레드, 고성능 |
| **Ubuntu 18.04+** | **Event** | 멀티스레드, 고성능 |

---

## 4. RHEL 계열 상세 가이드

### 4.1 CentOS 7 vs Rocky 8 vs Rocky 9 비교

| 항목 | CentOS 7 | Rocky 8 | Rocky 9 |
|------|----------|---------|---------|
| **패키지 관리자** | **YUM** | **DNF** | **DNF** |
| **Apache 버전** | 2.4.6 | 2.4.37 | 2.4.53 |
| **기본 MPM** | **Prefork** | **Event** | **Event** |
| **MySQL 버전** | 5.7 | 8.0 | 8.0 |
| **MariaDB 버전** | 10.5 | 10.3 | 10.5 |

### 4.2 RHEL 계열 공통 경로

#### Apache (httpd)

```bash
# 바이너리
/usr/sbin/httpd

# 기본 설정
/etc/httpd/conf/httpd.conf

# MPM 설정
/etc/httpd/conf.modules.d/00-mpm.conf

# 모듈 디렉토리
/etc/httpd/conf.modules.d/

# 로그
/var/log/httpd/access_log
/var/log/httpd/error_log
```

#### MySQL/MariaDB

```bash
# MySQL 바이너리
/usr/libexec/mysqld

# MariaDB 바이너리
/usr/libexec/mariadbd

# 기본 설정
/etc/my.cnf
/etc/my.cnf.d/server.cnf  # MariaDB

# 튜닝 설정 (스크립트가 생성)
/etc/my.cnf.d/zz-iteasy_tuning.cnf

# 데이터 디렉토리
/var/lib/mysql/

# 로그
/var/log/mysqld.log  # MySQL
/var/log/mariadb/mariadb.log  # MariaDB
```

### 4.3 RHEL 계열 패키지 설치 확인

#### CentOS 7 (YUM)

```bash
# Apache 확인
yum list installed | grep httpd
rpm -qa | grep httpd
which httpd  # /usr/sbin/httpd

# MySQL 확인
yum list installed | grep mysql-server
which mysqld  # /usr/libexec/mysqld

# MariaDB 확인
yum list installed | grep mariadb-server
which mariadbd  # /usr/libexec/mariadbd
```

#### Rocky 8/9 (DNF)

```bash
# Apache 확인
dnf list installed | grep httpd
rpm -qa | grep httpd
which httpd  # /usr/sbin/httpd

# MySQL 확인
dnf list installed | grep mysql-server
which mysqld  # /usr/libexec/mysqld

# MariaDB 확인
dnf list installed | grep mariadb-server
which mariadbd  # /usr/libexec/mariadbd
```

### 4.4 RHEL 계열 버전별 특징

#### CentOS 7 (레거시)

**특징**:
- Prefork MPM 기본
- MySQL 5.7 (레거시)

**주의사항**:
- MySQL 5.7 → 8.0 마이그레이션 고려
- Rocky Linux 8/9로 업그레이드 권장

#### Rocky Linux 8 (현역)

**특징**:
- DNF 패키지 관리자
- Event MPM 기본 (성능 향상)
- MySQL 8.0 지원

**신규 기능**:
- AppStream 리포지토리 (모듈 스트림)

#### Rocky Linux 9 (최신)

### 4.5 RHEL 계열 스크립트 특징

#### apply_apache.sh (RHEL)

```bash
#!/bin/bash
# RHEL 계열 Apache 적용 스크립트

TMP_CONF="$TMP_CONF_DIR/apache_tuning.conf"
TARGET_CONF="/etc/httpd/conf.modules.d/00-mpm.conf"

# 1. 추천 파일 확인
[ -f "$TMP_CONF" ] || exit 1

# 2. 백업
backup_files "$TARGET_CONF"

# 3. 복사
cp -f "$TMP_CONF" "$TARGET_CONF"
chmod 644 "$TARGET_CONF"
chown root:root "$TARGET_CONF"

# 4. 재시작 (검증 없음)
systemctl restart httpd
```

**특징**:
- 설정 검증 없음
- restart만 가능 (reload 미지원)
- 간단한 로직

#### apply_mysql.sh (RHEL)

```bash
#!/bin/bash
# RHEL 계열 MySQL 적용 스크립트

TMP_CONF="$TMP_CONF_DIR/mysql_tuning.cnf"
TARGET_CONF="/etc/my.cnf.d/zz-iteasy_tuning.cnf"

# 1. 백업
[ -f "$TARGET_CONF" ] && backup_files "$TARGET_CONF"

# 2. 복사
cp -f "$TMP_CONF" "$TARGET_CONF"

# 3. InnoDB 로그 파일 관리 (RHEL 전용)
OLD_LOG_SIZE=$(grep innodb_log_file_size /etc/my.cnf.d/*.cnf 2>/dev/null | tail -1 | awk -F'=' '{print $2}')
NEW_LOG_SIZE=$(grep innodb_log_file_size "$TARGET_CONF" | awk -F'=' '{print $2}')

if [ "$OLD_LOG_SIZE" != "$NEW_LOG_SIZE" ]; then
    systemctl stop mysqld
    rm -f /var/lib/mysql/ib_logfile*
    systemctl start mysqld
else
    systemctl restart mysqld
fi
```

**특징**:
- InnoDB 로그 파일 자동 제거
- 크기 변경 시 중지 → 삭제 → 시작

---

## 5. Debian 계열 상세 가이드

### 5.1 Ubuntu 버전별 비교

| 항목 | 18.04 (Bionic) | 20.04 (Focal) | 22.04 (Jammy) | 24.04 (Noble) |
|------|----------------|---------------|---------------|---------------|
| **Apache** | 2.4.29 | 2.4.41 | 2.4.52 | 2.4.58 |
| **MySQL** | 5.7 | 8.0 | 8.0 | 8.0 |
| **MariaDB** | 10.1 | 10.3 | 10.6 | 10.11 |
| **기본 MPM** | Event | Event | Event | Event |

### 5.2 Ubuntu 공통 경로

#### Apache (apache2)

```bash
# 바이너리
/usr/sbin/apache2

# 기본 설정
/etc/apache2/apache2.conf

# MPM 설정 (활성화된 MPM에 따라 다름)
/etc/apache2/mods-available/mpm_event.conf      # Event MPM
/etc/apache2/mods-available/mpm_prefork.conf    # Prefork MPM
/etc/apache2/mods-available/mpm_worker.conf     # Worker MPM

# 활성 모듈 (심볼릭 링크)
/etc/apache2/mods-enabled/mpm_event.conf -> ../mods-available/mpm_event.conf

# 로그
/var/log/apache2/access.log
/var/log/apache2/error.log
```

#### MySQL/MariaDB

```bash
# MySQL 바이너리
/usr/sbin/mysqld

# MariaDB 바이너리
/usr/sbin/mariadbd

# MySQL 기본 설정
/etc/mysql/mysql.conf.d/mysqld.cnf

# MariaDB 기본 설정
/etc/mysql/mariadb.conf.d/50-server.cnf

# 튜닝 설정 (스크립트가 생성)
/etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf

# 데이터 디렉토리
/var/lib/mysql/

# 로그
/var/log/mysql/error.log
```

### 5.3 Ubuntu 패키지 설치 확인

```bash
# Apache 확인
dpkg -l | grep apache2
apt list --installed | grep apache2
which apache2  # /usr/sbin/apache2

# 버전 확인
apache2 -v
# 출력: Server version: Apache/2.4.xx (Ubuntu)

# MySQL 확인
dpkg -l | grep mysql-server
which mysqld  # /usr/sbin/mysqld
mysqld --version

# MariaDB 확인
dpkg -l | grep mariadb-server
which mariadbd  # /usr/sbin/mariadbd
mariadbd --version
```

### 5.4 Ubuntu 버전별 특징

#### Ubuntu 18.04 LTS (Bionic Beaver)

**특징**:
- MySQL 5.7 (레거시)

**주의사항**:
- MySQL 5.7 → 8.0 마이그레이션 고려

#### Ubuntu 20.04 LTS (Focal Fossa)

**특징**:
- MySQL 8.0 (최신)
- 안정적인 LTS 버전

**주의사항**:
- MySQL 8.0 인증 플러그인 변경 (`caching_sha2_password`)
- 기존 애플리케이션은 `mysql_native_password` 필요할 수 있음

#### Ubuntu 22.04 LTS (Jammy Jellyfish)

**특징**:
- MariaDB 10.6

#### Ubuntu 24.04 LTS (Noble Numbat)

**특징**:
- Apache 2.4.58 (최신)
- MariaDB 10.11 (LTS)

### 5.5 Ubuntu 스크립트 특징

#### find_services.sh (Ubuntu)

```bash
#!/bin/bash
# Ubuntu Apache 탐지

# 1. 바이너리 확인
APACHE_BINARY=/usr/sbin/apache2

# 2. MPM 탐지 (2가지 방법)
# 방법 1: a2query 명령어 (권장)
enabled_mpm=$(a2query -m | grep -E 'mpm_(prefork|worker|event)' | awk '{print $1}' | head -1)
# 출력 예: mpm_event

# 방법 2: apache2ctl 사용
apache2ctl -V | grep -i 'Server MPM' | awk '{print $3}' | tr '[:upper:]' '[:lower:]'
# 출력 예: event

# 3. MPM 설정 파일
MPM_CONF="/etc/apache2/mods-available/${enabled_mpm}.conf"
# 예: /etc/apache2/mods-available/mpm_event.conf
```

#### apply_apache.sh (Ubuntu)

```bash
#!/bin/bash
# Ubuntu Apache 적용 스크립트

TMP_CONF="$TMP_CONF_DIR/apache_tuning.conf"
TARGET_CONF=$(kv_get_value "$SERVICE_LOG" "APACHE_MPM_CONF")
# 예: /etc/apache2/mods-available/mpm_event.conf

# 1. 백업
backup_files "$TARGET_CONF"

# 2. 복사
cp -f "$TMP_CONF" "$TARGET_CONF"
chmod 644 "$TARGET_CONF"

# 3. 설정 검증 (Ubuntu 전용)
if command -v apachectl &>/dev/null; then
    apachectl configtest || {
        echo "설정 검증 실패! 백업에서 복원합니다."
        # 복원 로직
        exit 1
    }
fi

# 4. Reload 우선 (무중단)
if systemctl is-active --quiet apache2; then
    systemctl reload apache2 || systemctl restart apache2
else
    systemctl restart apache2
fi
```

**특징**:
- `apachectl configtest`로 설정 검증
- reload 우선 (연결 끊김 없음)
- 검증 실패 시 자동 복원

#### apply_mysql.sh (Ubuntu)

```bash
#!/bin/bash
# Ubuntu MySQL 적용 스크립트

TMP_CONF="$TMP_CONF_DIR/mysql_tuning.cnf"
TARGET_CONF="/etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf"

# SERVICE_LOG에서 서비스 유닛 동적 읽기
MYSQL_UNIT=$(kv_get_value "$SERVICE_LOG" "MYSQL_SYSTEMD_UNIT")
MARIADB_UNIT=$(kv_get_value "$SERVICE_LOG" "MARIADB_SYSTEMD_UNIT")

# 우선순위: mariadb > mysql
if [ -n "$MARIADB_UNIT" ]; then
    SERVICE_UNIT="$MARIADB_UNIT"
elif [ -n "$MYSQL_UNIT" ]; then
    SERVICE_UNIT="$MYSQL_UNIT"
else
    SERVICE_UNIT="mysql.service"
fi

# 1. 백업
[ -f "$TARGET_CONF" ] && backup_files "$TARGET_CONF"

# 2. 복사
cp -f "$TMP_CONF" "$TARGET_CONF"

# 3. 재시작 (자동 복원 로직)
if ! systemctl restart "$SERVICE_UNIT"; then
    echo "MySQL 재시작 실패! 설정 복원 중..."
    rm -f "$TARGET_CONF"
    systemctl restart "$SERVICE_UNIT"
    exit 1
fi
```

**특징**:
- SERVICE_LOG에서 서비스 유닛명 동적 읽기
- 재시작 실패 시 설정 파일 자동 삭제 후 재시도
- InnoDB 로그 파일 관리 없음

### 5.6 Ubuntu 모듈 관리

```bash
# 활성화된 MPM 확인
a2query -m | grep mpm
# 출력: mpm_event (enabled by site administrator)

# MPM 변경 (event → prefork)
sudo a2dismod mpm_event
sudo a2enmod mpm_prefork
sudo systemctl restart apache2

# 활성화된 모듈 전체 확인
apache2ctl -M
# 또는
a2query -m

# SSL 모듈 활성화
sudo a2enmod ssl
sudo systemctl reload apache2

# HTTP/2 모듈 활성화
sudo a2enmod http2
sudo systemctl reload apache2
```

---

## 6. 스크립트 구조 및 기능

### 6.1 디렉토리 구조 (모든 OS 동일)

```
/usr/local/src/iteasy_tuning/
├── main.sh                          # 메인 진입점
├── modules/                          # 시스템 정보 수집 및 설정 계산
│   ├── get_server_specs.sh          # 메모리, CPU, 디스크 정보
│   ├── find_services.sh             # Apache/MySQL/MariaDB 탐지
│   ├── check_service_versions.sh    # 서비스 버전 확인
│   ├── calculate_mpm_config.sh      # Apache MPM 설정 계산
│   └── calculate_mysql_config.sh    # MySQL/MariaDB 설정 계산
├── scripts/
│   ├── common.sh                    # 공통 함수 (로깅, 권한)
│   ├── ui.sh                        # 사용자 입력 처리
│   ├── steps.sh                     # 파이프라인 단계 실행
│   ├── backup.sh                    # 설정 백업
│   ├── verify_tuning.sh             # 튜닝 검증
│   ├── lib/
│   │   └── kv_parser.sh             # KEY=VALUE 파서
│   ├── apply/
│   │   ├── apply_apache.sh          # Apache 설정 적용
│   │   ├── apply_mysql.sh           # MySQL 설정 적용
│   │   └── apply_mariadb.sh         # MariaDB 설정 적용 (RHEL만)
│   └── report/
│       └── generate_tuning_report.sh  # HTML 보고서 생성
├── logs/                             # 로그
│   ├── runtime/
│   │   ├── tuning_status.log        # 단계별 진행 상태
│   │   ├── apply.log                # 설정 적용 로그
│   │   └── tuning_report.html       # 최종 HTML 보고서
│   ├── debug/
│   │   └── pipeline-debug.log       # JSON 포맷 디버그 로그
│   └── artifacts/
│       ├── service_paths.log        # 서비스 경로
│       ├── system_specs.log         # 시스템 사양
│       ├── service_versions.log     # 서비스 버전
│       └── tuning_context.log       # 튜닝 컨텍스트
├── backups/                          # 설정 백업
│   └── {INDEX}_{YYYYMMDD}_{HHMMSS}_{FILENAME}
├── tmp_conf/                         # 임시 추천 설정
│   ├── apache_tuning.conf
│   └── mysql_tuning.cnf
└── err_conf/                         # 오류 설정 보관
```

### 6.2 스크립트별 상세 기능

#### main.sh (109줄) - 메인 파이프라인

**역할**: 전체 튜닝 프로세스 조정

**실행 순서**:
1. 루트 권한 확인
2. 로깅 시스템 초기화
3. 서비스 프로필 선택 (6가지)
4. DB 엔진 선택 (3가지, DB 포함 프로필만)
5. 튜닝 컨텍스트 기록
6. **병렬 실행** (Step 1-3):
   - 시스템 정보 수집
   - 서비스 탐지
   - 버전 확인
7. 튜닝 대상 서비스 결정
8. 기존 설정 백업
9. 추천 설정 계산
10. 사용자 적용 확인
11. 설정 적용 및 서비스 재시작
12. HTML 보고서 생성

**주요 환경변수**:
```bash
BASE_DIR="/usr/local/src/iteasy_tuning"
ITEASY_SERVICE_PROFILE   # web, web_was, web_db, web_was_db, was_db, db
ITEASY_DB_ENGINE         # innodb, myisam, mixed, none
TARGET_SERVICES[]        # 튜닝 대상 서비스 배열
DB_SERVICE_TARGET        # mysql 또는 mariadb
```

#### modules/get_server_specs.sh (26줄) - 시스템 정보 수집

**역할**: 하드웨어 리소스 자동 탐지

**수집 항목**:

| 항목 | 명령어 | 단위 | 예시 |
|------|--------|------|------|
| TOTAL_MEMORY | `awk '/MemTotal/ {printf "%d", $2/1024}' /proc/meminfo` | MB | 8192 |
| CPU_CORES | `nproc` | 개 | 4 |
| DISK_SPACE | `df -Pk / \| awk 'NR==2 {printf "%d", $4/1024}'` | MB | 51200 |

**출력 파일**: `logs/artifacts/system_specs.log`

**출력 예시**:
```bash
TOTAL_MEMORY=8192
CPU_CORES=4
DISK_SPACE=51200
```

#### modules/find_services.sh (132줄) - 서비스 탐지

**역할**: Apache/MySQL/MariaDB 자동 탐지 및 경로 파악

**주요 함수**:

```bash
check_service_active(unit, pattern)  # systemctl + pgrep 이중 확인
detect_apache()                       # Apache 탐지 (OS별 로직)
detect_mysql_family()                 # MySQL/MariaDB 탐지
```

**RHEL 탐지 로직**:
```bash
# Apache
APACHE_BINARY=/usr/sbin/httpd
APACHE_CONFIG=/etc/httpd/conf/httpd.conf
APACHE_MPM=$(httpd -V | grep 'Server MPM' | awk '{print $3}')
APACHE_MPM_CONF=/etc/httpd/conf.modules.d/00-mpm.conf

# MySQL
MYSQL_BINARY=/usr/libexec/mysqld
MYSQL_CONF=/etc/my.cnf
```

**Ubuntu 탐지 로직**:
```bash
# Apache
APACHE_BINARY=/usr/sbin/apache2
APACHE_CONFIG=/etc/apache2/apache2.conf
APACHE_MPM=$(a2query -m | grep mpm_ | awk '{print $1}')
APACHE_MPM_CONF=/etc/apache2/mods-available/${APACHE_MPM}.conf

# MySQL
MYSQL_BINARY=/usr/sbin/mysqld
MYSQL_CONF=/etc/mysql/mysql.conf.d/mysqld.cnf
```

**출력 파일**: `logs/artifacts/service_paths.log`

#### modules/check_service_versions.sh (45줄) - 버전 확인

**역할**: 서비스 버전 정보 수집

**수집 방법**:
```bash
# Apache
httpd -v | awk '/Server version/ {print $3}'                    # RHEL
apache2 -v | awk '/Server version/ {print $3}'                  # Ubuntu

# MySQL
mysqld --version | awk '{print $3}'

# MariaDB
mariadbd --version | awk '{print $3}'
```

**출력 파일**: `logs/artifacts/service_versions.log`

#### modules/calculate_mpm_config.sh (134줄) - Apache 설정 계산

**역할**: MPM 설정 자동 계산

**입력**:
- `ITEASY_SERVICE_PROFILE`: 서비스 프로필
- `TOTAL_MEMORY`: 총 메모리
- `CPU_CORES`: CPU 코어 수
- `APACHE_MPM`: MPM 타입

**메모리 할당 비율**:
```bash
web: 70%
web_was: 55%
web_db: 35%
web_was_db: 25%
was_db: 15%
db: 0%
```

**Prefork 계산**:
```bash
MaxRequestWorkers = target_memory / 60        # 범위: 50-8000
StartServers = cores * 2                      # 범위: 5-20
MinSpareServers = cores * 2                   # 범위: 5-50
MaxSpareServers = MinSpareServers * 2         # 범위: 10-200
MaxConnectionsPerChild = 10000                # 고정
```

**Worker/Event 계산**:
```bash
MaxRequestWorkers = target_memory / 4         # 범위: 300-10000
ThreadsPerChild = cores * 4                   # 범위: 16-64
ServerLimit = (MaxRequestWorkers + ThreadsPerChild - 1) / ThreadsPerChild
MinSpareThreads = max(16, ThreadsPerChild / 2)
MaxSpareThreads = min(256, MinSpareThreads * 2)
MaxConnectionsPerChild = 10000
```

**출력 파일**: `tmp_conf/apache_tuning.conf`

#### modules/calculate_mysql_config.sh (121줄) - MySQL 설정 계산

**역할**: MySQL/MariaDB 설정 자동 계산

**입력**:
- `ITEASY_SERVICE_PROFILE`: 서비스 프로필
- `ITEASY_DB_ENGINE`: DB 엔진
- `TOTAL_MEMORY`: 총 메모리
- `CPU_CORES`: CPU 코어 수

**메모리 할당 비율**:
```bash
web: 0%
web_was: 0%
web_db: 55%
web_was_db: 50%
was_db: 65%
db: 80%
```

**공통 설정 계산**:
```bash
max_connections = cores * 60                  # 범위: 200-1200
thread_cache_size = cores * 8                 # 범위: 32-256
table_open_cache = cores * 200                # 범위: 800-4000
tmp_table_size = 64MB (메모리 > 8GB면 128MB)
wait_timeout = 300
```

**엔진별 메모리 배분**:

| 엔진 | InnoDB 버퍼 | Key 버퍼 | 용도 |
|------|------------|---------|------|
| `innodb` | target * 70% | 64MB | InnoDB 전용 |
| `myisam` | target * 30% | target * 50% | MyISAM 전용 |
| `mixed` | target * 60% | target * 20% | 혼합 사용 |

**InnoDB 추가 설정**:
```bash
innodb_log_file_size = innodb_buffer_pool_size / 4       # 범위: 256-2048MB
innodb_buffer_pool_instances = innodb_buffer_pool_size / 1024  # 범위: 1-8
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1
```

**출력 파일**: `tmp_conf/mysql_tuning.cnf`

#### scripts/common.sh (366줄) - 공통 유틸리티

**역할**: 로깅, 권한 확인, JSON 함수

**주요 함수**:

```bash
# JSON 함수
json_kv(key, value)                       # {"key":"value"}
json_two(k1, v1, k2, v2)                  # {"k1":"v1","k2":"v2"}

# 로깅 함수
runtime_log(message)                      # 텍스트 로그
log_json(level, module, msg, detail)     # JSON 로그
log_info(msg, module, detail)            # INFO 레벨
log_warn(msg, module, detail)            # WARN 레벨
log_error(msg, module, detail)           # ERROR 레벨

# 권한 및 초기화
check_root()                              # EUID == 0 확인
setup_logging()                           # 로그 디렉토리 생성 (3단계 fallback)

# 사용자 상호작용
display_service_list()                    # 감지된 서비스 표시
prompt_for_apply()                        # A/S/N 선택
```

**로그 경로 Fallback**:
1. 주: `$LOG_ROOT`
2. 부: `/tmp/iteasy_tuning_logs`
3. 계획: `/var/log/iteasy_tuning`

#### scripts/ui.sh (115줄) - 사용자 인터페이스

**역할**: 사용자 입력 처리 및 정규화

**주요 함수**:

```bash
tty_echo(message)                         # TTY에만 출력
tty_read_line(prompt)                     # TTY에서 입력 읽기

normalize_choice(value)                   # 입력 정규화
  # - 공백 제거
  # - CR 제거
  # - 대문자 → 소문자
  # - ANSI 이스케이프 시퀀스 제거

prompt_service_profile()                  # 서비스 프로필 선택
  # 1=web, 2=web_was, 3=web_db, 4=web_was_db, 5=was_db, 6=db

prompt_db_engine()                        # DB 엔진 선택
  # 1=innodb, 2=myisam, 3=mixed, c=취소
```

#### scripts/steps.sh (183줄) - 파이프라인 단계 실행

**역할**: 각 단계 실행 및 로깅

**주요 함수**:

```bash
profile_requires_db(profile)              # DB 필요 여부 확인
record_tuning_context()                   # 튜닝 컨텍스트 기록
run_background_step(name, script, num)   # 백그라운드 실행
run_backup_step()                         # 백업 단계
run_calculation_steps()                   # 계산 단계
run_report_step()                         # 보고서 생성
gather_running_services()                 # 실행 중인 서비스 목록
determine_target_services()               # 튜닝 대상 결정
```

#### scripts/backup.sh (89줄) - 설정 백업

**역할**: 기존 설정 파일 백업

**백업 명명 규칙**:
```
{INDEX}_{YYYYMMDD}_{HHMMSS}_{FILENAME}

예시:
1_20250105_123456_00-mpm.conf
2_20250105_123500_zz-iteasy_tuning.cnf
```

**주요 함수**:

```bash
backup_files(files_array)                 # 여러 파일 백업
backup_service_conf(service, conf_list)  # 서비스별 백업
backup_all_services()                     # 전체 백업
```

**백업 대상**:
- **RHEL**: `/etc/httpd/conf.modules.d/00-mpm.conf`, `/etc/my.cnf.d/zz-iteasy_tuning.cnf`
- **Ubuntu**: `/etc/apache2/mods-available/mpm_*.conf`, `/etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf`

#### scripts/lib/kv_parser.sh (56줄) - KEY=VALUE 파서

**역할**: 로그 파일 파싱

**주요 함수**:

```bash
kv_trim(value)                            # 공백 제거
kv_get_value(file, key)                   # KEY의 VALUE 추출
kv_has_key(file, key)                     # KEY 존재 여부
kv_list_keys(file)                        # 모든 KEY 목록
```

**사용 예시**:
```bash
# system_specs.log에서 메모리 읽기
TOTAL_MEMORY=$(kv_get_value "$SYSTEM_LOG" "TOTAL_MEMORY")

# service_paths.log에서 Apache MPM 읽기
APACHE_MPM=$(kv_get_value "$SERVICE_LOG" "APACHE_MPM")
```

#### scripts/report/generate_tuning_report.sh (45줄) - HTML 보고서

**역할**: 최종 튜닝 결과 HTML 생성

**보고서 섹션**:
1. 서비스 탐지 결과 (경로, 버전, 실행 상태)
2. 단계별 실행 로그 (성공/실패)
3. Apache 추천 설정 (MPM 파라미터)
4. MySQL/MariaDB 추천 설정 (InnoDB, MyISAM)

**출력**: `logs/runtime/tuning_report.html`

---

## 7. 튜닝 로직 및 계산 공식

### 7.1 서비스 프로필 (6가지)

| 프로필 | Apache 메모리 | DB 메모리 | 사용 사례 |
|--------|--------------|-----------|----------|
| **web** | 70% | 0% | Apache 웹 서버 단독 (정적 콘텐츠) |
| **web_was** | 55% | 0% | Apache + WAS (Tomcat, JBoss 등) |
| **web_db** | 35% | 55% | Apache + DB (LAMP 스택) |
| **web_was_db** | 25% | 50% | Apache + WAS + DB (3-tier) |
| **was_db** | 15% | 65% | WAS + DB (백엔드 중심) |
| **db** | 0% | 80% | DB 서버 전용 |

### 7.2 DB 엔진 (3가지)

| 엔진 | InnoDB 버퍼 | Key 버퍼 | 사용 사례 |
|------|------------|---------|----------|
| **innodb** | 70% | 64MB | 트랜잭션 중심, 최신 애플리케이션 |
| **myisam** | 30% | 50% | 읽기 중심, 레거시 애플리케이션 |
| **mixed** | 60% | 20% | InnoDB + MyISAM 혼합 사용 |

### 7.3 Apache MPM 계산 상세

#### Prefork 모드 (프로세스 기반)

**특징**:
- 각 요청마다 별도 프로세스
- 메모리 사용량 높음
- PHP mod_php와 호환
- CentOS 7 기본

**계산 공식**:

| 파라미터 | 공식 | 범위 | 설명 |
|---------|------|------|------|
| MaxRequestWorkers | `target_memory / 60` | 50 - 8000 | 최대 동시 프로세스 (메모리 기반) |
| StartServers | `cores * 2` | 5 - 20 | 시작 시 생성 프로세스 |
| MinSpareServers | `cores * 2` | 5 - 50 | 최소 대기 프로세스 |
| MaxSpareServers | `MinSpareServers * 2` | 10 - 200 | 최대 대기 프로세스 |
| MaxConnectionsPerChild | 고정 | 10000 | 프로세스당 처리 후 재시작 |

**계산 예시 1**: 8GB 메모리, 4코어, `web_db` 프로필

```bash
# 1. 메모리 할당
target_memory = 8192 * 35% = 2867 MB

# 2. 각 파라미터 계산
MaxRequestWorkers = 2867 / 60 = 47 → 50 (최소값 적용)
StartServers = 4 * 2 = 8
MinSpareServers = 4 * 2 = 8
MaxSpareServers = 8 * 2 = 16
```

**출력**:
```apache
<IfModule mpm_prefork_module>
    StartServers          8
    MinSpareServers       8
    MaxSpareServers       16
    MaxRequestWorkers     50
    MaxConnectionsPerChild 10000
</IfModule>
```

**계산 예시 2**: 32GB 메모리, 16코어, `web` 프로필

```bash
target_memory = 32768 * 70% = 22937 MB
MaxRequestWorkers = 22937 / 60 = 382
StartServers = 16 * 2 = 32 → 20 (최대값 적용)
MinSpareServers = 16 * 2 = 32
MaxSpareServers = 32 * 2 = 64
```

**출력**:
```apache
<IfModule mpm_prefork_module>
    StartServers          20
    MinSpareServers       32
    MaxSpareServers       64
    MaxRequestWorkers     382
    MaxConnectionsPerChild 10000
</IfModule>
```

#### Worker/Event 모드 (스레드 기반)

**특징**:
- 각 프로세스가 여러 스레드 생성
- 메모리 효율적
- 고성능
- Rocky 8/9, Ubuntu 기본

**계산 공식**:

| 파라미터 | 공식 | 범위 | 설명 |
|---------|------|------|------|
| MaxRequestWorkers | `target_memory / 4` | 300 - 10000 | 최대 동시 스레드 |
| ThreadsPerChild | `cores * 4` | 16 - 64 | 프로세스당 스레드 수 |
| ServerLimit | `(MaxRequestWorkers + ThreadsPerChild - 1) / ThreadsPerChild` | 2 - 무제한 | 최대 프로세스 수 |
| MinSpareThreads | `max(16, ThreadsPerChild / 2)` | 최소 16 | 최소 대기 스레드 |
| MaxSpareThreads | `min(256, MinSpareThreads * 2)` | 최대 256 | 최대 대기 스레드 |
| MaxConnectionsPerChild | 고정 | 10000 | 스레드 재시작 주기 |

**계산 예시 1**: 8GB 메모리, 4코어, `web` 프로필

```bash
# 1. 메모리 할당
target_memory = 8192 * 70% = 5734 MB

# 2. 각 파라미터 계산
MaxRequestWorkers = 5734 / 4 = 1433
ThreadsPerChild = 4 * 4 = 16
ServerLimit = (1433 + 16 - 1) / 16 = 90
MinSpareThreads = max(16, 16/2) = 16
MaxSpareThreads = min(256, 16*2) = 32
```

**출력**:
```apache
<IfModule mpm_event_module>
    ThreadsPerChild       16
    MinSpareThreads       16
    MaxSpareThreads       32
    MaxRequestWorkers     1433
    ServerLimit           90
    MaxConnectionsPerChild 10000
</IfModule>
```

**계산 예시 2**: 64GB 메모리, 32코어, `web` 프로필

```bash
target_memory = 65536 * 70% = 45875 MB
MaxRequestWorkers = 45875 / 4 = 11468 → 10000 (최대값 적용)
ThreadsPerChild = 32 * 4 = 128 → 64 (최대값 적용)
ServerLimit = (10000 + 64 - 1) / 64 = 157
MinSpareThreads = max(16, 64/2) = 32
MaxSpareThreads = min(256, 32*2) = 64
```

**출력**:
```apache
<IfModule mpm_event_module>
    ThreadsPerChild       64
    MinSpareThreads       32
    MaxSpareThreads       64
    MaxRequestWorkers     10000
    ServerLimit           157
    MaxConnectionsPerChild 10000
</IfModule>
```

### 7.4 MySQL/MariaDB 계산 상세

#### 공통 설정

| 파라미터 | 공식 | 범위 | 설명 |
|---------|------|------|------|
| max_connections | `cores * 60` | 200 - 1200 | 최대 동시 연결 수 |
| thread_cache_size | `cores * 8` | 32 - 256 | 스레드 캐시 크기 |
| table_open_cache | `cores * 200` | 800 - 4000 | 테이블 캐시 크기 |
| tmp_table_size | 64MB (메모리 > 8GB면 128MB) | - | 임시 테이블 크기 |
| wait_timeout | 고정 | 300 | 연결 대기 시간 (초) |

**계산 예시 1**: 8GB 메모리, 4코어

```bash
max_connections = 4 * 60 = 240
thread_cache_size = 4 * 8 = 32
table_open_cache = 4 * 200 = 800
tmp_table_size = 64MB (메모리 8GB 이하)
```

**계산 예시 2**: 32GB 메모리, 16코어

```bash
max_connections = 16 * 60 = 960
thread_cache_size = 16 * 8 = 128
table_open_cache = 16 * 200 = 3200
tmp_table_size = 128MB (메모리 8GB 초과)
```

#### InnoDB 전용 (innodb 엔진)

**메모리 배분**:
- InnoDB 버퍼: target * 70%
- Key 버퍼: 64MB (고정)

**추가 설정**:

| 파라미터 | 공식 | 범위 |
|---------|------|------|
| innodb_buffer_pool_size | `target * 70%` | - |
| innodb_log_file_size | `innodb_buffer_pool_size / 4` | 256MB - 2048MB |
| innodb_buffer_pool_instances | `innodb_buffer_pool_size / 1024` | 1 - 8 |
| innodb_flush_log_at_trx_commit | 고정 | 2 |
| innodb_flush_method | 고정 | O_DIRECT |
| innodb_file_per_table | 고정 | 1 |

**계산 예시**: 16GB 메모리, 8코어, `db` 프로필

```bash
# 1. DB 메모리 할당
target_memory = 16384 * 80% = 13107 MB

# 2. InnoDB 설정
innodb_buffer_pool_size = 13107 * 70% = 9174 MB
innodb_log_file_size = 9174 / 4 = 2293 MB → 2048 MB (최대값)
innodb_buffer_pool_instances = 9174 / 1024 = 8
key_buffer_size = 64 MB
```

**출력**:
```ini
[mysqld]
max_connections = 480
thread_cache_size = 64
table_open_cache = 1600
tmp_table_size = 128M

innodb_buffer_pool_size = 9174M
innodb_buffer_pool_instances = 8
innodb_log_file_size = 2048M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1

key_buffer_size = 64M
```

#### MyISAM 전용 (myisam 엔진)

**메모리 배분**:
- InnoDB 버퍼: target * 30%
- Key 버퍼: target * 50%

**계산 예시**: 16GB 메모리, 8코어, `db` 프로필

```bash
target_memory = 16384 * 80% = 13107 MB

innodb_buffer_pool_size = 13107 * 30% = 3932 MB
key_buffer_size = 13107 * 50% = 6553 MB
innodb_log_file_size = 3932 / 4 = 983 MB
innodb_buffer_pool_instances = 3932 / 1024 = 3
```

**출력**:
```ini
[mysqld]
max_connections = 480
thread_cache_size = 64
table_open_cache = 1600
tmp_table_size = 128M

innodb_buffer_pool_size = 3932M
innodb_buffer_pool_instances = 3
innodb_log_file_size = 983M

key_buffer_size = 6553M
```

#### Mixed (innodb + myisam)

**메모리 배분**:
- InnoDB 버퍼: target * 60%
- Key 버퍼: target * 20%

**계산 예시**: 32GB 메모리, 16코어, `web_db` 프로필

```bash
target_memory = 32768 * 55% = 18022 MB

innodb_buffer_pool_size = 18022 * 60% = 10813 MB
key_buffer_size = 18022 * 20% = 3604 MB
innodb_log_file_size = 10813 / 4 = 2048 MB (최대값)
innodb_buffer_pool_instances = 10813 / 1024 = 8 (최대값)
```

**출력**:
```ini
[mysqld]
max_connections = 960
thread_cache_size = 128
table_open_cache = 3200
tmp_table_size = 128M

innodb_buffer_pool_size = 10813M
innodb_buffer_pool_instances = 8
innodb_log_file_size = 2048M

key_buffer_size = 3604M
```

### 7.5 시나리오별 종합 계산 예시

#### 시나리오 1: 소규모 웹 서버 (2GB, 2코어)

**프로필**: `web`

**시스템 정보**:
```
TOTAL_MEMORY=2048
CPU_CORES=2
```

**Apache** (70% = 1433MB, Prefork):
```apache
<IfModule mpm_prefork_module>
    StartServers          5
    MinSpareServers       5
    MaxSpareServers       10
    MaxRequestWorkers     50
    MaxConnectionsPerChild 10000
</IfModule>
```

**MySQL**: 없음 (0%)

#### 시나리오 2: 중규모 웹+DB 서버 (8GB, 4코어)

**프로필**: `web_db`
**DB 엔진**: `innodb`

**시스템 정보**:
```
TOTAL_MEMORY=8192
CPU_CORES=4
```

**Apache** (35% = 2867MB, Event):
```apache
<IfModule mpm_event_module>
    ThreadsPerChild       16
    MinSpareThreads       16
    MaxSpareThreads       32
    MaxRequestWorkers     716
    ServerLimit           45
    MaxConnectionsPerChild 10000
</IfModule>
```

**MySQL** (55% = 4505MB):
```ini
[mysqld]
max_connections = 240
thread_cache_size = 32
table_open_cache = 800
tmp_table_size = 64M

innodb_buffer_pool_size = 3153M
innodb_buffer_pool_instances = 3
innodb_log_file_size = 788M

key_buffer_size = 64M
```

#### 시나리오 3: 대규모 DB 서버 (64GB, 32코어)

**프로필**: `db`
**DB 엔진**: `mixed`

**시스템 정보**:
```
TOTAL_MEMORY=65536
CPU_CORES=32
```

**Apache**: 없음 (0%)

**MySQL** (80% = 52428MB):
```ini
[mysqld]
max_connections = 1200
thread_cache_size = 256
table_open_cache = 4000
tmp_table_size = 128M

innodb_buffer_pool_size = 31457M
innodb_buffer_pool_instances = 8
innodb_log_file_size = 2048M

key_buffer_size = 10485M
```

#### 시나리오 4: 엔터프라이즈 3-Tier (128GB, 64코어)

**프로필**: `web_was_db`
**DB 엔진**: `innodb`

**시스템 정보**:
```
TOTAL_MEMORY=131072
CPU_CORES=64
```

**Apache** (25% = 32768MB, Event):
```apache
<IfModule mpm_event_module>
    ThreadsPerChild       64
    MinSpareThreads       32
    MaxSpareThreads       64
    MaxRequestWorkers     8192
    ServerLimit           128
    MaxConnectionsPerChild 10000
</IfModule>
```

**MySQL** (50% = 65536MB):
```ini
[mysqld]
max_connections = 1200
thread_cache_size = 256
table_open_cache = 4000
tmp_table_size = 128M

innodb_buffer_pool_size = 45875M
innodb_buffer_pool_instances = 8
innodb_log_file_size = 2048M

key_buffer_size = 64M
```

---

## 8. 실행 가이드

### 8.1 사전 준비

#### 필수 요구사항

1. **루트 권한**:
```bash
# 현재 사용자 확인
whoami
# 출력: root

# 또는 sudo 사용
sudo bash main.sh
```

2. **패키지 설치 확인**:

**RHEL (CentOS/Rocky)**:
```bash
# Apache 확인
rpm -qa | grep httpd
which httpd

# MySQL/MariaDB 확인
rpm -qa | grep mysql-server
rpm -qa | grep mariadb-server
```

**Ubuntu**:
```bash
# Apache 확인
dpkg -l | grep apache2
which apache2

# MySQL/MariaDB 확인
dpkg -l | grep mysql-server
dpkg -l | grep mariadb-server
```

3. **디스크 공간 확인**:
```bash
df -h /
# 최소 500MB 여유 공간 권장
```

#### 주의사항

⚠️ **운영 서버 주의**:
- 반드시 테스트 환경에서 먼저 검증
- 백업 필수
- 점검 시간대에 실행

⚠️ **지원하지 않는 환경**:
- 소스 컴파일 설치 (`/usr/local/` 경로)
- 타사 리포지토리 (Remi, Webtatic 등)
- 컨테이너 환경 (일부 제한)

### 8.2 기본 실행

#### 1단계: 디렉토리 이동

```bash
cd /usr/local/src/iteasy_tuning
```

#### 2단계: 실행 권한 확인

```bash
chmod +x main.sh
```

#### 3단계: 스크립트 실행

```bash
sudo bash main.sh
```

### 8.3 대화형 실행 과정

#### 프롬프트 1: 서비스 프로필 선택

```
==========================================
서비스 구성을 선택하세요.
  1) web          - Apache 단독
  2) web_was      - Apache + WAS
  3) web_db       - Apache + DB
  4) web_was_db   - Apache + WAS + DB
  5) was_db       - WAS + DB
  6) db           - DB 전용
  c) 취소
>
```

**입력 예시**: `3` (web_db)

#### 프롬프트 2: DB 엔진 선택 (DB 포함 프로필만)

```
==========================================
DB 엔진을 선택하세요.
  1) innodb
  2) myisam
  3) mixed (innodb + myisam)
  c) 취소
>
```

**입력 예시**: `1` (innodb)

#### 프롬프트 3: 감지된 서비스 정보

**RHEL (CentOS/Rocky)**:
```
==========================================
감지된 서비스 및 설정 정보
==========================================
- apache
  원본 설정: /etc/httpd/conf.modules.d/00-mpm.conf
  튜닝 저장: /etc/httpd/conf.modules.d/00-mpm.conf

- mysql
  원본 설정: /etc/my.cnf
  튜닝 저장: /etc/my.cnf.d/zz-iteasy_tuning.cnf
==========================================
```

**Ubuntu**:
```
==========================================
감지된 서비스 및 설정 정보
==========================================
- apache
  원본 설정: /etc/apache2/mods-available/mpm_event.conf
  튜닝 저장: /etc/apache2/mods-available/mpm_event.conf

- mysql
  원본 설정: /etc/mysql/mysql.conf.d/mysqld.cnf
  튜닝 저장: /etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf
==========================================
```

#### 프롬프트 4: 설정 적용 확인

```
설정을 적용하시겠습니까?
  A: 전체 적용
  S: 직접 선택
  N: 종료
>
```

**입력 예시**: `A` (전체 적용)

#### 실행 결과

**RHEL**:
```
[Apache 설정 적용 중...]
백업 파일: /usr/local/src/iteasy_tuning/backups/1_20250105_123456_00-mpm.conf
설정 파일 복사 완료: /etc/httpd/conf.modules.d/00-mpm.conf
httpd 재시작 완료

[MySQL 설정 적용 중...]
백업 파일: /usr/local/src/iteasy_tuning/backups/2_20250105_123500_zz-iteasy_tuning.cnf
InnoDB 로그 파일 재생성 중...
mysqld 재시작 완료

==========================================
튜닝 완료!
- 보고서: /usr/local/src/iteasy_tuning/logs/runtime/tuning_report.html
- 로그: /usr/local/src/iteasy_tuning/logs/runtime/tuning_status.log
- 백업: /usr/local/src/iteasy_tuning/backups/
==========================================
```

**Ubuntu**:
```
[Apache 설정 적용 중...]
백업 파일: /usr/local/src/iteasy_tuning/backups/1_20250105_123456_mpm_event.conf
설정 파일 복사 완료: /etc/apache2/mods-available/mpm_event.conf
설정 검증 완료: Syntax OK
apache2 reload 완료

[MySQL 설정 적용 중...]
백업 파일: /usr/local/src/iteasy_tuning/backups/2_20250105_123500_zz-iteasy_tuning.cnf
mysql 재시작 완료

==========================================
튜닝 완료!
- 보고서: /usr/local/src/iteasy_tuning/logs/runtime/tuning_report.html
- 로그: /usr/local/src/iteasy_tuning/logs/runtime/tuning_status.log
- 백업: /usr/local/src/iteasy_tuning/backups/
==========================================
```

### 8.4 로그 확인

#### 실행 로그

```bash
# 단계별 진행 상태
cat /usr/local/src/iteasy_tuning/logs/runtime/tuning_status.log
```

**출력 예시**:
```
=== [단계 1 - 시스템 정보 수집] ===
시간 = 2025-01-05 12:34:56
단계 1 (시스템 정보 수집) = 성공

=== [단계 2 - 서비스 탐지] ===
시간 = 2025-01-05 12:34:57
단계 2 (서비스 탐지) = 성공

=== [단계 3 - 서비스 버전 확인] ===
시간 = 2025-01-05 12:34:58
단계 3 (서비스 버전 확인) = 성공
```

#### JSON 디버그 로그

```bash
# JSON 포맷 로그
cat /usr/local/src/iteasy_tuning/logs/debug/pipeline-debug.log | jq .
```

**출력 예시**:
```json
{"ts":"2025-01-05T12:34:56+0900","level":"INFO","module":"main","msg":"서비스 프로필 선택","detail":{"profile":"web_db"}}
{"ts":"2025-01-05T12:34:57+0900","level":"INFO","module":"specs","msg":"시스템 자원을 수집했습니다","detail":{"memory_mb":"8192","cpu":"4"}}
{"ts":"2025-01-05T12:35:00+0900","level":"INFO","module":"apache","msg":"Apache 튜닝 설정을 생성했습니다","detail":{"mpm":"event","output":"/usr/local/src/iteasy_tuning/tmp_conf/apache_tuning.conf"}}
```

#### 서비스 정보

```bash
# 시스템 사양
cat /usr/local/src/iteasy_tuning/logs/artifacts/system_specs.log
```

**출력**:
```
TOTAL_MEMORY=8192
CPU_CORES=4
DISK_SPACE=51200
```

```bash
# 서비스 경로
cat /usr/local/src/iteasy_tuning/logs/artifacts/service_paths.log
```

**출력 (RHEL)**:
```
# Apache
APACHE_BINARY=/usr/sbin/httpd
APACHE_CONFIG=/etc/httpd/conf/httpd.conf
APACHE_MPM_CONF=/etc/httpd/conf.modules.d/00-mpm.conf
APACHE_MPM=prefork
APACHE_RUNNING=1

# MySQL
MYSQL_BINARY=/usr/libexec/mysqld
MYSQL_CONF=/etc/my.cnf
MYSQL_RUNNING=1
```

**출력 (Ubuntu)**:
```
# Apache
APACHE_BINARY=/usr/sbin/apache2
APACHE_CONFIG=/etc/apache2/apache2.conf
APACHE_MPM_CONF=/etc/apache2/mods-available/mpm_event.conf
APACHE_MPM=event
APACHE_RUNNING=1

# MySQL
MYSQL_BINARY=/usr/sbin/mysqld
MYSQL_CONF=/etc/mysql/mysql.conf.d/mysqld.cnf
MYSQL_RUNNING=1
MYSQL_SYSTEMD_UNIT=mysql.service
```

```bash
# 서비스 버전
cat /usr/local/src/iteasy_tuning/logs/artifacts/service_versions.log
```

**출력**:
```
APACHE_VERSION=2.4.41
MYSQL_VERSION=8.0.35
```

### 8.5 백업 및 복원

#### 백업 파일 확인

```bash
ls -lh /usr/local/src/iteasy_tuning/backups/
```

**출력 예시**:
```
total 16K
-rw-r--r-- 1 root root 1.2K Jan  5 12:35 1_20250105_123500_00-mpm.conf
-rw-r--r-- 1 root root 2.4K Jan  5 12:35 2_20250105_123505_zz-iteasy_tuning.cnf
```

#### Apache 설정 복원

**RHEL (CentOS/Rocky)**:
```bash
# 백업 파일 복원
sudo cp /usr/local/src/iteasy_tuning/backups/1_20250105_123500_00-mpm.conf \
   /etc/httpd/conf.modules.d/00-mpm.conf

# Apache 재시작
sudo systemctl restart httpd

# 상태 확인
sudo systemctl status httpd
```

**Ubuntu**:
```bash
# 백업 파일 복원
sudo cp /usr/local/src/iteasy_tuning/backups/1_20250105_123500_mpm_event.conf \
   /etc/apache2/mods-available/mpm_event.conf

# 설정 검증
sudo apachectl configtest

# Apache reload (무중단)
sudo systemctl reload apache2

# 상태 확인
sudo systemctl status apache2
```

#### MySQL 설정 복원

**RHEL (CentOS/Rocky)**:
```bash
# 방법 1: 백업 파일 복원
sudo cp /usr/local/src/iteasy_tuning/backups/2_20250105_123505_zz-iteasy_tuning.cnf \
   /etc/my.cnf.d/zz-iteasy_tuning.cnf
sudo systemctl restart mysqld

# 방법 2: 튜닝 설정 제거 (원본 설정 사용)
sudo rm /etc/my.cnf.d/zz-iteasy_tuning.cnf
sudo systemctl restart mysqld
```

**Ubuntu**:
```bash
# 방법 1: 백업 파일 복원
sudo cp /usr/local/src/iteasy_tuning/backups/2_20250105_123505_zz-iteasy_tuning.cnf \
   /etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf
sudo systemctl restart mysql

# 방법 2: 튜닝 설정 제거
sudo rm /etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf
sudo systemctl restart mysql
```

### 8.6 보고서 확인

#### HTML 보고서 열기

```bash
# 보고서 위치
/usr/local/src/iteasy_tuning/logs/runtime/tuning_report.html

# 브라우저로 열기 (로컬 환경)
xdg-open /usr/local/src/iteasy_tuning/logs/runtime/tuning_report.html

# 또는 cat으로 확인 (원격 환경)
cat /usr/local/src/iteasy_tuning/logs/runtime/tuning_report.html
```

#### 웹 서버로 보고서 제공

```bash
# Apache DocumentRoot에 심볼릭 링크 생성
sudo ln -s /usr/local/src/iteasy_tuning/logs/runtime/tuning_report.html \
   /var/www/html/tuning_report.html

# 브라우저에서 접속
# http://your-server-ip/tuning_report.html
```

---

## 9. 트러블슈팅

### 9.1 공통 문제

#### 문제 1: 루트 권한 없음

**증상**:
```
Error: 이 스크립트는 루트 권한이 필요합니다.
```

**해결**:
```bash
# sudo 사용
sudo bash main.sh

# 또는 root 전환
su -
bash /usr/local/src/iteasy_tuning/main.sh
```

#### 문제 2: 서비스 탐지 실패

**증상**:
```
APACHE_RUNNING=0
MYSQL_RUNNING=0
```

**원인**:
- 서비스가 설치되지 않음
- 서비스가 중지됨
- 비표준 경로에 설치됨

**해결**:

**RHEL**:
```bash
# Apache 설치 확인
rpm -qa | grep httpd
# 없으면 설치
sudo dnf install httpd  # Rocky 8/9
sudo yum install httpd  # CentOS 7

# 서비스 시작
sudo systemctl start httpd
sudo systemctl enable httpd
```

**Ubuntu**:
```bash
# Apache 설치 확인
dpkg -l | grep apache2
# 없으면 설치
sudo apt update
sudo apt install apache2

# 서비스 시작
sudo systemctl start apache2
sudo systemctl enable apache2
```

#### 문제 3: 로그 디렉토리 생성 실패

**증상**:
```
Error: LOG_ROOT를 생성하지 못했습니다
```

**원인**:
- 디스크 공간 부족
- 권한 문제

**해결**:
```bash
# 디스크 공간 확인
df -h /

# 수동 디렉토리 생성
sudo mkdir -p /usr/local/src/iteasy_tuning/logs
sudo mkdir -p /usr/local/src/iteasy_tuning/logs/runtime
sudo mkdir -p /usr/local/src/iteasy_tuning/logs/debug
sudo mkdir -p /usr/local/src/iteasy_tuning/logs/artifacts
```

### 9.2 RHEL 계열 문제

#### 문제 1: SELinux 차단

**증상**:
```
Permission denied
AVC denial
```

**해결**:
```bash
# SELinux 상태 확인
getenforce

# 임시 비활성화 (테스트용)
sudo setenforce 0

# 영구 비활성화 (권장하지 않음)
sudo vi /etc/selinux/config
# SELINUX=disabled

# 또는 SELinux 컨텍스트 설정
sudo restorecon -Rv /usr/local/src/iteasy_tuning
```

#### 문제 2: 방화벽 차단

**증상**:
- Apache는 실행 중이지만 외부 접속 불가

**해결**:
```bash
# 방화벽 상태 확인
sudo firewall-cmd --list-all

# HTTP/HTTPS 허용
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

# MySQL 포트 허용 (필요 시)
sudo firewall-cmd --permanent --add-port=3306/tcp
sudo firewall-cmd --reload
```

#### 문제 3: InnoDB 로그 파일 제거 실패

**증상**:
```
rm: cannot remove '/var/lib/mysql/ib_logfile0': Permission denied
```

**해결**:
```bash
# MySQL 중지
sudo systemctl stop mysqld

# 수동 제거
sudo rm -f /var/lib/mysql/ib_logfile*

# MySQL 시작
sudo systemctl start mysqld

# 상태 확인
sudo systemctl status mysqld
```

### 9.3 Ubuntu 계열 문제

#### 문제 1: Apache 설정 검증 실패

**증상**:
```
apachectl configtest
Syntax error on line XX
```

**원인**:
- 잘못된 설정 구문
- 모듈 누락

**해결**:
```bash
# 에러 로그 확인
sudo tail -f /var/log/apache2/error.log

# 설정 파일 수동 확인
sudo vi /etc/apache2/mods-available/mpm_event.conf

# 백업에서 복원
sudo cp /usr/local/src/iteasy_tuning/backups/1_*.conf \
   /etc/apache2/mods-available/mpm_event.conf

# 검증
sudo apachectl configtest
```

#### 문제 2: MySQL 재시작 실패

**증상**:
```
Job for mysql.service failed
```

**원인**:
- 잘못된 설정
- 메모리 부족
- 디스크 공간 부족

**해결**:
```bash
# 에러 로그 확인
sudo tail -f /var/log/mysql/error.log

# 설정 파일 확인
sudo vi /etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf

# 튜닝 설정 제거 후 재시도
sudo rm /etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf
sudo systemctl start mysql

# 상태 확인
sudo systemctl status mysql
```

#### 문제 3: AppArmor 차단

**증상**:
```
Permission denied
apparmor="DENIED"
```

**해결**:
```bash
# AppArmor 상태 확인
sudo aa-status

# MySQL 프로파일 비활성화 (임시)
sudo aa-complain /usr/sbin/mysqld

# 또는 프로파일 수정
sudo vi /etc/apparmor.d/usr.sbin.mysqld
# /etc/mysql/mariadb.conf.d/ r, 추가
# /etc/mysql/mariadb.conf.d/* r, 추가

# 재로드
sudo systemctl reload apparmor
```

### 9.4 성능 문제

#### 문제 1: Apache MaxRequestWorkers 부족

**증상**:
```
[mpm_event:error] server reached MaxRequestWorkers setting, consider raising the MaxRequestWorkers setting
```

**해결**:
```bash
# 현재 설정 확인
grep MaxRequestWorkers /etc/httpd/conf.modules.d/00-mpm.conf  # RHEL
grep MaxRequestWorkers /etc/apache2/mods-available/mpm_event.conf  # Ubuntu

# 수동 조정 (Event MPM)
sudo vi /etc/apache2/mods-available/mpm_event.conf
# MaxRequestWorkers를 더 높은 값으로 변경 (예: 2000)

# 재시작
sudo systemctl restart apache2
```

#### 문제 2: MySQL 메모리 부족

**증상**:
```
Cannot allocate memory for the buffer pool
```

**원인**:
- innodb_buffer_pool_size가 너무 큼

**해결**:
```bash
# 현재 메모리 사용량 확인
free -h

# innodb_buffer_pool_size 줄이기
sudo vi /etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf
# innodb_buffer_pool_size를 줄임 (예: 4G → 2G)

# 재시작
sudo systemctl restart mysql
```

#### 문제 3: 디스크 I/O 병목

**증상**:
- MySQL 느림
- `top`에서 wa (wait) 높음

**해결**:
```bash
# I/O 상태 확인
iostat -x 1

# innodb_flush_method 확인
grep innodb_flush_method /etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf
# O_DIRECT가 아니면 변경

# 또는 SSD 사용 확인
lsblk
```

### 9.5 디버그 방법

#### 상세 로그 활성화

```bash
# Apache 로그 레벨 높이기 (RHEL)
sudo vi /etc/httpd/conf/httpd.conf
# LogLevel info → LogLevel debug
sudo systemctl restart httpd

# Apache 로그 레벨 높이기 (Ubuntu)
sudo vi /etc/apache2/apache2.conf
# LogLevel warn → LogLevel debug
sudo systemctl restart apache2

# MySQL 일반 쿼리 로그 활성화
sudo vi /etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf
# general_log = 1
# general_log_file = /var/log/mysql/general.log
sudo systemctl restart mysql
```

#### 스크립트 디버그 모드

```bash
# Bash 디버그 모드
bash -x /usr/local/src/iteasy_tuning/main.sh

# 또는 스크립트 내부에 추가
set -x  # 디버그 시작
# ... 코드 ...
set +x  # 디버그 종료
```

---

## 부록

### 부록 A: 빠른 참조 테이블

#### 서비스 프로필 메모리 할당

| 프로필 | Apache | MySQL | 예시 (16GB) |
|--------|--------|-------|------------|
| web | 70% | 0% | Apache: 11.2GB, MySQL: 0GB |
| web_was | 55% | 0% | Apache: 8.8GB, MySQL: 0GB |
| web_db | 35% | 55% | Apache: 5.6GB, MySQL: 8.8GB |
| web_was_db | 25% | 50% | Apache: 4GB, MySQL: 8GB |
| was_db | 15% | 65% | Apache: 2.4GB, MySQL: 10.4GB |
| db | 0% | 80% | Apache: 0GB, MySQL: 12.8GB |

#### DB 엔진 메모리 배분

| 엔진 | InnoDB | Key | 예시 (10GB DB 메모리) |
|------|--------|-----|---------------------|
| innodb | 70% | 64MB | InnoDB: 7GB, Key: 64MB |
| myisam | 30% | 50% | InnoDB: 3GB, Key: 5GB |
| mixed | 60% | 20% | InnoDB: 6GB, Key: 2GB |

#### 경로 빠른 참조

| 항목 | RHEL | Ubuntu |
|------|------|--------|
| Apache 바이너리 | `/usr/sbin/httpd` | `/usr/sbin/apache2` |
| Apache MPM 설정 | `/etc/httpd/conf.modules.d/00-mpm.conf` | `/etc/apache2/mods-available/mpm_*.conf` |
| MySQL 튜닝 설정 | `/etc/my.cnf.d/zz-iteasy_tuning.cnf` | `/etc/mysql/mariadb.conf.d/zz-iteasy_tuning.cnf` |
| Apache 로그 | `/var/log/httpd/` | `/var/log/apache2/` |
| MySQL 로그 | `/var/log/` | `/var/log/mysql/` |

### 부록 B: 명령어 치트시트

#### RHEL (CentOS/Rocky)

```bash
# 패키지 관리
dnf install httpd mysql-server  # Rocky 8/9
yum install httpd mysql-server  # CentOS 7
rpm -qa | grep httpd

# 서비스 관리
systemctl start httpd
systemctl enable httpd
systemctl restart mysqld
systemctl status mysqld

# Apache 제어
httpd -V  # 버전 및 MPM 확인
httpd -M  # 모듈 확인
httpd -t  # 설정 검증 (없음)

# 방화벽
firewall-cmd --list-all
firewall-cmd --permanent --add-service=http
firewall-cmd --reload

# SELinux
getenforce
setenforce 0
```

#### Ubuntu

```bash
# 패키지 관리
apt update
apt install apache2 mysql-server
dpkg -l | grep apache2

# 서비스 관리
systemctl start apache2
systemctl enable apache2
systemctl restart mysql
systemctl status mysql

# Apache 제어
apache2 -V  # 버전 확인
a2query -m  # MPM 확인
apachectl configtest  # 설정 검증
a2enmod mpm_event  # 모듈 활성화
a2dismod mpm_prefork  # 모듈 비활성화
systemctl reload apache2  # 무중단 reload

# 방화벽
ufw status
ufw allow 'Apache Full'
ufw allow 3306/tcp

# AppArmor
aa-status
aa-complain /usr/sbin/mysqld
```

### 부록 C: 참고 자료

#### 공식 문서

- **Apache HTTP Server**: https://httpd.apache.org/docs/2.4/
- **Apache MPM**: https://httpd.apache.org/docs/2.4/mpm.html
- **MySQL 8.0**: https://dev.mysql.com/doc/refman/8.0/en/
- **MariaDB**: https://mariadb.com/kb/en/

#### 성능 튜닝

- **Apache Performance Tuning**: https://httpd.apache.org/docs/2.4/misc/perf-tuning.html
- **MySQL Performance Schema**: https://dev.mysql.com/doc/refman/8.0/en/performance-schema.html
- **MariaDB Optimization**: https://mariadb.com/kb/en/optimization-and-tuning/

#### OS별 가이드

- **CentOS 7 Release Notes**: https://wiki.centos.org/Manuals/ReleaseNotes/CentOS7
- **Rocky Linux Documentation**: https://docs.rockylinux.org/
- **Ubuntu Server Guide**: https://ubuntu.com/server/docs

---

**작성일**: 2025-11-05
**버전**: v2.0
**프로젝트**: iteasy_tuning

---

**문서 끝**
